# Database Scripts

This directory contains SQL scripts for database initialization.

## Files

### `schema.sql`
Creates the database schema with:
- **DROP TABLE IF EXISTS messages** - Clean slate
- **CREATE TABLE messages** - Main messages table
- **CHECK constraint** - Enforces 500 character limit on content
- **CREATE INDEX** - Performance indexes on status, sent_at, created_at
- **COMMENT** - Documentation for table and columns

**Key Features:**
- `content TEXT NOT NULL CHECK (LENGTH(content) <= 500)` - **500 character limit enforced at database level**
- Indexes for fast queries
- Default status = 'pending'

### `seed.sql`
Inserts 15 sample messages for testing:
- All messages have status = 'pending'
- All messages are within 500 character limit
- Diverse message types (welcome, verification, order, etc.)

### `init_db.sh`
Bash script that:
1. Waits for PostgreSQL to be ready
2. Runs schema.sql
3. Runs seed.sql
4. Verifies data was inserted

**Used by docker-compose's `db_init` service**

## Character Limit Enforcement

The 500 character limit is enforced at **multiple levels**:

1. **Database Level** (PRIMARY):
   ```sql
   content TEXT NOT NULL CHECK (LENGTH(content) <= 500)
   ```
   - PostgreSQL will reject any INSERT/UPDATE with content > 500 chars
   - Error: `new row for relation "messages" violates check constraint`

2. **Application Level** (FUTURE - can be added):
   ```go
   if len(content) > 500 {
       return fmt.Errorf("content exceeds 500 characters")
   }
   ```

## Usage

### Automatic (via Docker Compose)
```bash
docker-compose up -d
# db_init service automatically runs these scripts
```

### Manual
```bash
# Connect to database
docker exec -it insider_postgres psql -U insider -d insider_db

# Run schema
\i /scripts/schema.sql

# Run seed
\i /scripts/seed.sql
```

### Add Your Own Messages

Edit `seed.sql` and add:
```sql
INSERT INTO messages (phone_number, content, status) VALUES
('+905551234567', 'Your message here (max 500 chars)', 'pending');
```

Then restart:
```bash
docker-compose down -v
docker-compose up -d
```

## Verification

Check the constraint is working:
```sql
-- This should succeed (within limit)
INSERT INTO messages (phone_number, content, status) VALUES
('+905551111111', 'Short message', 'pending');

-- This should FAIL (exceeds limit)
INSERT INTO messages (phone_number, content, status) VALUES
('+905551111111', REPEAT('A', 501), 'pending');
-- ERROR: new row violates check constraint "messages_content_check"
```

## Notes

- All sample messages in `seed.sql` are verified to be â‰¤ 500 characters
- The CHECK constraint name is auto-generated by PostgreSQL: `messages_content_check`
- If you need to change the limit, update the CHECK constraint in `schema.sql`

